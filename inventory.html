<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vessel Inventory - Sovereigns of Ruin</title>
    <style>
        :root { --accent: #62ffe1; }
        body { background: #000; margin: 0; display: flex; justify-content: center; height: 100dvh; overflow: hidden; font-family: 'Inter', sans-serif; color: #eee; }
        
        .game-window {
            width: 400px; height: 100dvh; background: #000; display: flex; flex-direction: column;
            border-left: 1px solid #111; border-right: 1px solid #111; position: relative;
        }

        .top-nav { padding: 15px 20px; border-bottom: 1px solid #111; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; background: #050505; }
        .back-link { color: #555; text-decoration: none; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 2px; font-weight: bold; cursor: pointer; }
        .back-link:hover { color: var(--accent); }

        .vitals-container { padding: 12px 20px; display: flex; flex-direction: column; gap: 8px; border-bottom: 1px solid #111; background: #050505; }
        .vital-text { display: flex; justify-content: space-between; font-size: 0.55rem; font-weight: bold; text-transform: uppercase; color: #555; }
        .vital-bar-wrap { width: 100%; height: 6px; background: #111; border-radius: 2px; overflow: hidden; border: 1px solid #1a1a1a; }
        .vital-fill { height: 100%; width: 0%; transition: width 0.5s ease; }
        .hp-fill { background: #ff4444; box-shadow: 0 0 8px #ff444466; }
        .mp-fill { background: #22ccff; box-shadow: 0 0 8px #22ccff66; }

        .stats-summary { display: flex; gap: 10px; padding: 12px 20px; background: #080808; border-bottom: 1px solid #111; }
        .stat-box { flex: 1; padding: 8px; background: #000; border: 1px solid #1a1a1a; border-radius: 4px; text-align: center; }
        .stat-label { display: block; font-size: 0.5rem; color: #444; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .stat-value { font-size: 0.9rem; font-weight: bold; color: #eee; font-family: monospace; }
        .stat-value span { color: var(--accent); font-size: 0.6rem; margin-left: 2px; }

        .inv-tabs { display: flex; border-bottom: 1px solid #111; background: #050505; }
        .inv-tab { flex: 1; padding: 12px; text-align: center; font-size: 0.65rem; color: #444; text-transform: uppercase; cursor: pointer; font-weight: bold; }
        .inv-tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); }

        .inv-content { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .item-card { background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 12px; position: relative; }
        .item-card.equipped { border-color: var(--accent); background: linear-gradient(90deg, #0a0a0a, #051515); }
        .equipped-tag { position: absolute; top: -5px; right: 10px; background: var(--accent); color: #000; font-size: 0.5rem; padding: 2px 6px; font-weight: bold; border-radius: 2px; }

        .item-icon { width: 40px; height: 40px; background: #111; border: 1px solid #222; border-radius: 4px; display: flex; justify-content: center; align-items: center; font-size: 1.1rem; }
        .item-details { flex-grow: 1; }
        .item-name { display: block; color: #eee; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .item-stat { display: block; color: #666; font-size: 0.55rem; font-family: monospace; margin-top: 2px; }
        .refine-level { color: var(--accent); font-weight: bold; margin-left: 4px; }

        .use-btn { background: transparent; border: 1px solid #333; color: #888; font-size: 0.55rem; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .use-btn.active-action { border-color: var(--accent); color: var(--accent); }

        .theme-Fire { --accent: #ff4444; } .theme-Water { --accent: #22ccff; } .theme-Wind { --accent: #a8ff62; }
        .theme-Earth { --accent: #ffcc66; } .theme-Soul { --accent: #62ffe1; } .theme-Shadow { --accent: #bf66ff; }
    </style>
</head>
<body id="bodyTheme">

    <div class="game-window">
        <div class="top-nav">
            <a href="map.html" class="back-link">‚Üê WORLD MAP</a>
            <span class="back-link" id="pGold">0 GOLD</span>
        </div>

        <div class="vitals-container">
            <div class="vital-text"><span>VITALITY</span><span id="txt-hp">0/0</span></div>
            <div class="vital-bar-wrap"><div id="bar-hp" class="vital-fill hp-fill"></div></div>
            <div class="vital-text"><span>ESSENCE</span><span id="txt-mp">0/0</span></div>
            <div class="vital-bar-wrap"><div id="bar-mp" class="vital-fill mp-fill"></div></div>
        </div>

        <div class="stats-summary">
            <div class="stat-box">
                <span class="stat-label">POWER (ATK)</span>
                <span class="stat-value" id="totalAtk">0</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">RESILIENCE (DEF)</span>
                <span class="stat-value" id="totalDef">0</span>
            </div>
        </div>

        <div class="inv-tabs">
            <div id="tab-gear" class="inv-tab active" onclick="window.switchTab('gear')">Armory</div>
            <div id="tab-arcane" class="inv-tab" onclick="window.switchTab('arcane')">Satchel</div>
        </div>

        <div class="inv-content" id="invContent"></div>

        <div class="top-nav" style="border-top: 1px solid #111;">
            <span class="back-link">CAPACITY: <span id="invWeight" style="color:#eee">0/25</span></span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { initSecurity } from "./auth-guard.js";
        import { getInventoryWeight } from "./system.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCfYnzHzZ82Qdvxsd2U4bSKpDwrQ8g2WuM", 
            authDomain: "sovereigns-of-ruin.firebaseapp.com", 
            projectId: "sovereigns-of-ruin", 
            appId: "1:1098142064736:web:002a76b2e1f8f7b22f6305" 
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentCategory = 'gear';
        let pData = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await initSecurity(db, auth, user);
                onSnapshot(doc(db, "players", user.uid), (snap) => {
                    if (snap.exists()) {
                        pData = snap.data();
                        updateUI();
                    }
                });
            } else { window.location.href = "index.html"; }
        });

        function updateUI() {
            const el = pData.element || 'Soul';
            document.getElementById('bodyTheme').className = `theme-${el}`;
            document.getElementById('pGold').innerText = `${pData.gold || 0} G`;
            
            const stats = pData.stats || { hp:100, maxHp:100, mana:50, maxMana:50 };
            document.getElementById('txt-hp').innerText = `${Math.floor(stats.hp)}/${stats.maxHp}`;
            document.getElementById('txt-mp').innerText = `${Math.floor(stats.mana)}/${stats.maxMana}`;
            document.getElementById('bar-hp').style.width = `${(stats.hp/stats.maxHp)*100}%`;
            document.getElementById('bar-mp').style.width = `${(stats.mana/stats.maxMana)*100}%`;
            
            calculateGearTotals();
            renderInventory();
        }

        function calculateGearTotals() {
            let atk = 0; let def = 0;
            (pData.inventory || []).forEach(item => {
                if (item.equipped) {
                    if (item.atk) atk += item.atk;
                    if (item.def) def += item.def;
                }
            });
            document.getElementById('totalAtk').innerHTML = `${atk} <span>ATK</span>`;
            document.getElementById('totalDef').innerHTML = `${def} <span>DEF</span>`;
        }

        window.switchTab = (cat) => {
            currentCategory = cat;
            document.querySelectorAll('.inv-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${cat}`).classList.add('active');
            renderInventory();
        };

        function renderInventory() {
            const container = document.getElementById('invContent');
            container.innerHTML = '';
            const inv = pData.inventory || [];
            
            document.getElementById('invWeight').innerText = `${getInventoryWeight(inv)}/25`;

            const filtered = inv.filter(item => {
                const isUsable = (item.type === 'potion' || item.type === 'scroll');
                return currentCategory === 'arcane' ? isUsable : !isUsable;
            });

            if (filtered.length === 0) {
                container.innerHTML = `<div style="color:#222; text-align:center; font-size:0.6rem; margin-top:40px;">EMPTY</div>`;
                return;
            }

            filtered.forEach((item) => {
                const card = document.createElement('div');
                card.className = `item-card ${item.equipped ? 'equipped' : ''}`;
                
                let statDisplay = "CONSUMABLE";
                if (item.atk) statDisplay = `ATK: ${item.atk}`;
                else if (item.def) statDisplay = `DEF: ${item.def}`;
                else if (item.hp_heal) statDisplay = `+${item.hp_heal} HP`;
                else if (item.mp_heal) statDisplay = `+${item.mp_heal} MP`;

                const refineBadge = (item.refineLevel > 0) ? `<span class="refine-level">+${item.refineLevel}</span>` : '';

                card.innerHTML = `
                    ${item.equipped ? '<div class="equipped-tag">ACTIVE</div>' : ''}
                    <div class="item-icon">${item.emoji || 'üì¶'}</div>
                    <div class="item-details">
                        <span class="item-name">${item.name}${refineBadge}</span>
                        <span class="item-stat">${statDisplay}</span>
                    </div>
                    <button class="use-btn ${item.equipped ? '' : 'active-action'}" 
                        onclick="window.handleAction('${item.uid}', '${item.type}')">
                        ${getActionLabel(item)}
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function getActionLabel(item) {
            if (item.type === 'potion' || item.type === 'scroll') return 'USE';
            return item.equipped ? 'REMOVE' : 'EQUIP';
        }

        window.handleAction = async (uid, type) => {
            const userRef = doc(db, "players", auth.currentUser.uid);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const snap = await transaction.get(userRef);
                    const data = snap.data();
                    let inv = [...data.inventory];
                    let stats = {...data.stats};

                    const idx = inv.findIndex(i => i.uid === uid);
                    if (idx === -1) return;
                    const item = inv[idx];

                    // Consumable Logic
                    if (type === 'potion' || type === 'scroll') {
                        if (item.hp_heal) stats.hp = Math.min(stats.maxHp, stats.hp + item.hp_heal);
                        if (item.mp_heal) stats.mana = Math.min(stats.maxMana, stats.mana + item.mp_heal);
                        inv.splice(idx, 1);
                    } else {
                        // Gear Logic
                        const isEquipping = !item.equipped;
                        if (isEquipping) {
                            inv = inv.map(i => {
                                if (i.type === item.type) return {...i, equipped: false};
                                return i;
                            });
                        }
                        inv[inv.findIndex(i => i.uid === uid)].equipped = isEquipping;
                    }

                    transaction.update(userRef, { inventory: inv, stats: stats });
                });
            } catch (e) {
                console.error("Action failed", e);
            }
        };
    </script>
</body>
</html>