<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vessel Inventory - Sovereigns of Ruin</title>
    <style>
        :root { --accent: #62ffe1; }
        body { background: #000; margin: 0; display: flex; justify-content: center; height: 100dvh; overflow: hidden; font-family: 'Inter', sans-serif; }
        
        .game-window {
            width: 400px; height: 100dvh; background: #000; display: flex; flex-direction: column;
            border-left: 1px solid #111; border-right: 1px solid #111; position: relative;
        }

        /* NAVIGATION */
        .top-nav { padding: 15px 20px; border-bottom: 1px solid #111; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; background: #050505; }
        .back-link { color: #555; text-decoration: none; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 2px; font-weight: bold; cursor: pointer; }
        .back-link:hover { color: var(--accent); }

        #restBanner { display: none; background: linear-gradient(90deg, #440000, #880000, #440000); color: #fff; font-size: 0.6rem; text-align: center; padding: 8px; text-transform: uppercase; cursor: pointer; font-weight: bold; }

        /* VITALS & STAT SUMMARY */
        .vitals-container { padding: 12px 20px; display: flex; flex-direction: column; gap: 8px; border-bottom: 1px solid #111; background: #050505; }
        .vital-text { display: flex; justify-content: space-between; font-size: 0.55rem; font-weight: bold; text-transform: uppercase; color: #555; }
        .vital-bar-wrap { width: 100%; height: 6px; background: #111; border-radius: 2px; overflow: hidden; border: 1px solid #1a1a1a; }
        .vital-fill { height: 100%; width: 0%; transition: width 0.5s ease; }
        .hp-fill { background: #ff4444; box-shadow: 0 0 8px #ff444466; }
        .mp-fill { background: #22ccff; box-shadow: 0 0 8px #22ccff66; }

        .stats-summary { 
            display: flex; gap: 10px; padding: 12px 20px; background: #080808; border-bottom: 1px solid #111;
        }
        .stat-box { 
            flex: 1; padding: 8px; background: #000; border: 1px solid #1a1a1a; border-radius: 4px; text-align: center;
        }
        .stat-label { display: block; font-size: 0.5rem; color: #444; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .stat-value { font-size: 0.9rem; font-weight: bold; color: #eee; font-family: monospace; }
        .stat-value span { color: var(--accent); font-size: 0.6rem; margin-left: 2px; }

        /* TABS */
        .inv-tabs { display: flex; border-bottom: 1px solid #111; background: #050505; }
        .inv-tab { flex: 1; padding: 12px; text-align: center; font-size: 0.65rem; color: #444; text-transform: uppercase; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .inv-tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); background: rgba(255,255,255,0.02); }

        /* LIST CONTENT */
        .inv-content { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .inv-content::-webkit-scrollbar { width: 4px; }
        .inv-content::-webkit-scrollbar-thumb { background: #222; }

        .item-card { 
            background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 8px; padding: 12px; 
            display: flex; align-items: center; gap: 12px; position: relative; transition: 0.2s;
        }
        .item-card.equipped { border-color: var(--accent) !important; background: linear-gradient(90deg, #0a0a0a, #051515); }
        .equipped-tag { position: absolute; top: -5px; right: 10px; background: var(--accent); color: #000; font-size: 0.5rem; padding: 2px 6px; font-weight: bold; border-radius: 2px; }

        .item-icon { width: 40px; height: 40px; background: #111; border: 1px solid #222; border-radius: 6px; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; }
        .item-details { flex-grow: 1; }
        .item-name { display: block; color: #eee; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .item-stat { display: block; color: #666; font-size: 0.55rem; margin-top: 2px; font-family: monospace; }
        .item-count { color: #ffd700; font-size: 0.7rem; margin-left: 5px; font-weight: bold; }
        .refine-text { color: var(--accent); font-weight: bold; }

        .use-btn { 
            background: transparent; border: 1px solid #333; color: #888; 
            font-size: 0.55rem; padding: 6px 10px; border-radius: 4px; cursor: pointer; 
            text-transform: uppercase; font-weight: bold; transition: 0.2s;
        }
        .use-btn.active-action { border-color: var(--accent); color: var(--accent); }

        /* SKILL MENU */
        .skill-side-menu { position: absolute; right: -100%; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); transition: 0.3s; z-index: 100; visibility: hidden; backdrop-filter: blur(5px); }
        .skill-side-menu.active { right: 0; visibility: visible; }
        .menu-content { width: 80%; height: 100%; background: #050505; margin-left: auto; padding: 20px; border-left: 1px solid #222; box-sizing: border-box; }

        /* THEMES */
        .theme-Fire { --accent: #ff4444; } .theme-Water { --accent: #22ccff; } .theme-Wind { --accent: #a8ff62; }
        .theme-Earth { --accent: #ffcc66; } .theme-Soul { --accent: #62ffe1; } .theme-Shadow { --accent: #bf66ff; }
    </style>
</head>
<body id="bodyTheme">

    <div class="game-window">
        <div id="restBanner" onclick="window.location.href='rest.html'">Healing in progress... Tap to return</div>

        <div id="skillMenu" class="skill-side-menu">
            <div class="menu-content">
                <h3 style="color:var(--accent); font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase;">Bind Arcane</h3>
                <p id="equippingName" style="font-size: 0.6rem; color: #555; margin-bottom: 20px;"></p>
                <div id="skillSlotsContainer"></div>
                <button onclick="window.closeEquipMenu()" class="back-link" style="margin-top: 30px; border:none; background:none; cursor:pointer; display: block; width: 100%;">[ Close ]</button>
            </div>
        </div>

        <div class="top-nav">
            <a href="map.html" class="back-link">‚Üê Village Map</a>
            <span class="back-link" id="pGold">0 GOLD</span>
        </div>

        <div class="vitals-container">
            <div class="vital-text"><span>Vitality</span><span id="txt-hp">0/0</span></div>
            <div class="vital-bar-wrap"><div id="bar-hp" class="vital-fill hp-fill"></div></div>
            <div class="vital-text"><span>Essence</span><span id="txt-mp">0/0</span></div>
            <div class="vital-bar-wrap"><div id="bar-mp" class="vital-fill mp-fill"></div></div>
        </div>

        <div class="stats-summary">
            <div class="stat-box">
                <span class="stat-label">Power (ATK)</span>
                <span class="stat-value" id="totalAtk">0</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">Resilience (DEF)</span>
                <span class="stat-value" id="totalDef">0</span>
            </div>
        </div>

        <div class="inv-tabs">
            <div id="tab-gear" class="inv-tab active" onclick="window.switchTab('gear')">Gear</div>
            <div id="tab-arcane" class="inv-tab" onclick="window.switchTab('arcane')">Arcane</div>
        </div>

        <div class="inv-content" id="invContent"></div>

        <div class="top-nav" style="border-top: 1px solid #111; border-bottom:none;">
            <span class="back-link">Inventory Slots: <span id="invWeight" style="color:#eee">0/25</span></span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { initSecurity } from "./auth-guard.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCfYnzHzZ82Qdvxsd2U4bSKpDwrQ8g2WuM", 
            authDomain: "sovereigns-of-ruin.firebaseapp.com", 
            projectId: "sovereigns-of-ruin", 
            appId: "1:1098142064736:web:002a76b2e1f8f7b22f6305" 
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentCategory = 'gear';
        let playerData = null;
        let selectedSpellToEquip = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await initSecurity(db, auth, user);
                onSnapshot(doc(db, "players", user.uid), (snap) => {
                    if (snap.exists()) {
                        playerData = snap.data();
                        updateUI();
                    }
                });
            } else { window.location.href = "index.html"; }
        });

        function updateUI() {
            const el = playerData.element || 'Soul';
            document.getElementById('bodyTheme').className = `theme-${el.charAt(0).toUpperCase() + el.slice(1)}`;
            document.getElementById('pGold').innerText = `${playerData.gold || 0} GOLD`;
            
            const stats = playerData.stats || { hp:100, maxHp:100, mana:50, maxMana:50 };
            document.getElementById('txt-hp').innerText = `${Math.floor(stats.hp)}/${stats.maxHp}`;
            document.getElementById('txt-mp').innerText = `${Math.floor(stats.mana)}/${stats.maxMana}`;
            document.getElementById('bar-hp').style.width = `${(stats.hp/stats.maxHp)*100}%`;
            document.getElementById('bar-mp').style.width = `${(stats.mana/stats.maxMana)*100}%`;
            
            calculateTotalStats();
            document.getElementById('restBanner').style.display = playerData.isResting ? 'block' : 'none';
            renderInventory();
        }

        function calculateTotalStats() {
            let bonusAtk = 0;
            let bonusDef = 0;
            const inv = playerData.inventory || [];
            inv.forEach(item => {
                if (item.equipped) {
                    const refineBonus = (item.refineLevel || 0) * 2;
                    const baseAtk = item.atk || 0;
                    const baseDef = item.def || 0;
                    if (item.statType === 'atk' || item.type === 'weapon') bonusAtk += baseAtk + refineBonus;
                    if (item.statType === 'def' || item.type === 'armor' || item.type === 'helm' || item.type === 'legendary') bonusDef += baseDef + refineBonus;
                }
            });
            document.getElementById('totalAtk').innerHTML = `${bonusAtk} <span>ATK</span>`;
            document.getElementById('totalDef').innerHTML = `${bonusDef} <span>DEF</span>`;
        }

        window.switchTab = (cat) => {
            currentCategory = cat;
            document.querySelectorAll('.inv-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${cat}`).classList.add('active');
            renderInventory();
        };

        function renderInventory() {
            const container = document.getElementById('invContent');
            container.innerHTML = '';
            const inv = playerData.inventory || [];

            // --- GROUPING LOGIC (Stacks count as 1 slot) ---
            const groupedItems = [];
            inv.forEach(item => {
                // Potions are stackable
                if (item.type === 'potion') {
                    const existing = groupedItems.find(g => g.id === item.id);
                    if (existing) {
                        existing.count++;
                        existing.uids.push(item.uid);
                    } else {
                        groupedItems.push({ ...item, count: 1, uids: [item.uid] });
                    }
                } else {
                    // Gear/Unique items are not stacked
                    groupedItems.push({ ...item, count: 1, uids: [item.uid] });
                }
            });

            // Weight is now the number of UNIQUE slots taken
            document.getElementById('invWeight').innerText = `${groupedItems.length}/25`;

            const filtered = groupedItems.filter(item => {
                const isArcane = (item.type === 'spell' || item.type === 'manuscript' || item.type === 'potion');
                return currentCategory === 'arcane' ? isArcane : !isArcane;
            });

            if (filtered.length === 0) {
                container.innerHTML = `<div style="color:#222; text-align:center; font-size:0.6rem; margin-top:30px; letter-spacing:2px;">EMPTY</div>`;
                return;
            }

            filtered.forEach((item) => {
                const card = document.createElement('div');
                card.className = `item-card ${item.equipped ? 'equipped' : ''}`;
                
                const statKey = item.statType || (item.type === 'weapon' ? 'atk' : 'def');
                const baseVal = item[statKey] || 0;
                const refineBonus = (item.refineLevel || 0) * 2;
                const totalStat = baseVal + refineBonus;
                const refineBadge = item.refineLevel > 0 ? `<span class="refine-text"> +${item.refineLevel}</span>` : '';
                const countBadge = item.count > 1 ? `<span class="item-count">(x${item.count})</span>` : '';

                card.innerHTML = `
                    ${item.equipped ? '<div class="equipped-tag">ACTIVE</div>' : ''}
                    <div class="item-icon">${item.emoji || 'üì¶'}</div>
                    <div class="item-details">
                        <span class="item-name">${item.name}${refineBadge} ${countBadge}</span>
                        <span class="item-stat">${item.type === 'potion' ? 'Consumable' : '+' + totalStat + ' ' + statKey.toUpperCase()}</span>
                    </div>
                    <button class="use-btn ${item.equipped ? '' : 'active-action'}" 
                        onclick="window.handleItemAction('${item.uids[0]}', '${item.type}', '${item.name}')">
                        ${getActionLabel(item)}
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function getActionLabel(item) {
            if (item.type === 'potion') return 'USE';
            if (item.type === 'spell') return 'BIND';
            if (['weapon', 'armor', 'helm', 'legendary'].includes(item.type)) {
                return item.equipped ? 'REMOVE' : 'EQUIP';
            }
            return 'USE';
        }

        window.handleItemAction = async (uid, type, name) => {
            const userRef = doc(db, "players", auth.currentUser.uid);
            let updatedInv = [...playerData.inventory];

            if (['weapon', 'armor', 'helm', 'legendary'].includes(type)) {
                const itemIndex = updatedInv.findIndex(i => i.uid === uid);
                const isEquipping = !updatedInv[itemIndex].equipped;
                if (isEquipping) {
                    updatedInv = updatedInv.map(i => {
                        if (i.type === type) return { ...i, equipped: false };
                        return i;
                    });
                }
                updatedInv[itemIndex].equipped = isEquipping;
            } 
            else if (type === 'potion') {
                const idx = updatedInv.findIndex(i => i.uid === uid);
                if (idx > -1) {
                    alert(`Used ${name}`);
                    updatedInv.splice(idx, 1);
                }
            }
            else if (type === 'spell') {
                window.openEquipMenu(name);
                return;
            }

            await updateDoc(userRef, { inventory: updatedInv });
        };

        window.openEquipMenu = (spellName) => {
            selectedSpellToEquip = spellName;
            document.getElementById('equippingName').innerText = `Bind ${spellName} to a slot:`;
            document.getElementById('skillMenu').classList.add('active');
            renderSlots();
        };

        window.closeEquipMenu = () => {
            document.getElementById('skillMenu').classList.remove('active');
        };

        function renderSlots() {
            const container = document.getElementById('skillSlotsContainer');
            container.innerHTML = '';
            const currentSkills = playerData.skills || [null, null, null, null];
            
            currentSkills.forEach((skill, index) => {
                const div = document.createElement('div');
                div.style = "background:#111; padding:12px; margin-bottom:10px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; border: 1px solid #1a1a1a;";
                div.innerHTML = `
                    <div style="font-size:0.55rem; color:#555; text-transform:uppercase;">Slot ${index+1}<br><b style="color:#eee; font-size:0.65rem;">${skill || 'EMPTY'}</b></div>
                    <button class="use-btn active-action" onclick="window.confirmSkillBind(${index})">BIND</button>
                `;
                container.appendChild(div);
            });
        }

        window.confirmSkillBind = async (slotIndex) => {
            const userRef = doc(db, "players", auth.currentUser.uid);
            let skills = [...(playerData.skills || [null, null, null, null])];
            skills = skills.map(s => s === selectedSpellToEquip ? null : s);
            skills[slotIndex] = selectedSpellToEquip;
            await updateDoc(userRef, { skills });
            window.closeEquipMenu();
        };
    </script>
</body>
</html>