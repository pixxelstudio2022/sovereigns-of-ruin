<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Elder's Riddle - Sovereigns of Ruin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .quiz-container { flex-grow: 1; display: flex; flex-direction: column; text-align: center; padding: 10px; }
        .timer-bar { width: 100%; height: 6px; background: #111; border-radius: 3px; margin-bottom: 25px; overflow: hidden; border: 1px solid #222; }
        #timerFill { width: 100%; height: 100%; background: var(--accent); transition: width 0.1s linear; }
        
        #questionText { font-size: 1rem; margin-bottom: 25px; min-height: 80px; color: #eee; line-height: 1.5; padding: 0 10px; font-weight: bold;}
        .answers-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        
        .ans-btn { 
            background: #0a0a0a; border: 1px solid #222; color: #999; 
            padding: 14px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;
            transition: 0.2s; text-transform: uppercase; letter-spacing: 1px;
        }
        .ans-btn:hover:not(:disabled) { border-color: var(--accent); background: #111; color: #fff; }
        .ans-btn.correct { background: rgba(0, 255, 100, 0.1) !important; border-color: #00ff66 !important; color: #00ff66; font-weight: bold; }
        .ans-btn.wrong { background: rgba(255, 0, 0, 0.1) !important; border-color: #ff4444 !important; color: #ff4444; }

        .reward-popup { font-size: 0.75rem; color: #ffcc00; margin-top: 20px; font-weight: bold; opacity: 0; transition: 0.3s; letter-spacing: 1px; }
        .limit-popup { color: #ff4444; font-size: 0.65rem; margin-top: 20px; display: none; font-weight: bold; }
        .back-nav { font-size: 0.7rem; color: #444; cursor: pointer; margin-bottom: 15px; align-self: flex-start; transition: 0.2s; }
        .back-nav:hover { color: var(--accent); }
    </style>
</head>
<body id="bodyTheme"> 
    <div class="game-container" style="width: 400px; margin: 0 auto;">
        <div class="scroll-area">
            <div class="back-nav" onclick="window.location.href='map.html'">‚Üê RETURN TO VILLAGE</div>
            
            <div class="quiz-container">
                <div style="font-size: 0.55rem; color: #444; margin-bottom: 8px; letter-spacing: 2px; text-transform: uppercase;">Temporal Essence</div>
                <div class="timer-bar"><div id="timerFill"></div></div>

                <div id="questionText">The Elder is contemplating...</div>
                
                <div class="answers-grid" id="answerButtons"></div>

                <div id="rewardMsg" class="reward-popup">+1 GOLD EARNED</div>
                <div id="limitMsg" class="limit-popup">GOLD LIMIT EXCEEDED FOR THE DAY</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        import { initSecurity } from "./auth-guard.js";
        import { saQuizPool } from "./questions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCfYnzHzZ82Qdvxsd2U4bSKpDwrQ8g2WuM",
            authDomain: "sovereigns-of-ruin.firebaseapp.com",
            projectId: "sovereigns-of-ruin",
            storageBucket: "sovereigns-of-ruin.firebasestorage.app",
            messagingSenderId: "1098142064736",
            appId: "1:1098142064736:web:002a76b2e1f8f7b22f6305"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUid = null;
        let timerInterval;
        let timeLeft = 100;

        onAuthStateChanged(auth, async (user) => { 
            if (user) { 
                currentUid = user.uid; 
                initSecurity(db, auth, user);
                nextQuestion(); 
            } else { 
                window.location.href = "index.html"; 
            }
        });

        function nextQuestion() {
            clearInterval(timerInterval);
            document.getElementById('rewardMsg').style.opacity = 0;
            document.getElementById('limitMsg').style.display = "none";

            const randomIndex = Math.floor(Math.random() * saQuizPool.length);
            const qData = saQuizPool[randomIndex];

            document.getElementById('questionText').innerText = qData.q;
            const btnContainer = document.getElementById('answerButtons');
            btnContainer.innerHTML = "";

            qData.a.forEach((text, index) => {
                const b = document.createElement('button');
                b.className = "ans-btn";
                b.innerText = text;
                b.onclick = () => checkAnswer(index, qData.c, b);
                btnContainer.appendChild(b);
            });
            startTimer();
        }

        function startTimer() {
            timeLeft = 100;
            const bar = document.getElementById('timerFill');
            timerInterval = setInterval(() => {
                timeLeft -= 1; 
                bar.style.width = timeLeft + "%";
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    nextQuestion(); 
                }
            }, 100); 
        }

        async function checkAnswer(selected, correct, btn) {
            clearInterval(timerInterval);
            const allBtns = document.querySelectorAll('.ans-btn');
            allBtns.forEach(b => b.disabled = true);

            if (selected === correct) {
                btn.classList.add('correct');
                
                try {
                    const playerRef = doc(db, "players", currentUid);
                    const snap = await getDoc(playerRef);
                    const data = snap.data();
                    
                    const today = new Date().toDateString();
                    const lastDate = data.lastGoldDate || "";
                    let currentDailyCount = (lastDate === today) ? (data.dailyGoldCount || 0) : 0;

                    if (currentDailyCount < 100) {
                        await updateDoc(playerRef, { 
                            gold: increment(1),
                            dailyGoldCount: (lastDate !== today) ? 1 : increment(1),
                            lastGoldDate: today
                        });
                        document.getElementById('rewardMsg').style.opacity = 1;
                    } else {
                        document.getElementById('limitMsg').style.display = "block";
                    }
                } catch (e) {
                    console.error("Gold distribution failed:", e);
                }
            } else {
                btn.classList.add('wrong');
                allBtns[correct].classList.add('correct');
            }

            setTimeout(nextQuestion, 1500);
        }
    </script>
</body>
</html>