<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quest Log - Sovereigns of Ruin</title>
    <style>
        :root { --accent: #ff8800; }
        body { background: #000; margin: 0; display: flex; justify-content: center; height: 100dvh; overflow: hidden; font-family: 'Inter', sans-serif; }
        .game-window { width: 400px; height: 100dvh; background: #000; display: flex; flex-direction: column; border-left: 1px solid #111; border-right: 1px solid #111; position: relative; }
        
        /* THEMES */
        .theme-Fire { --accent: #ff4444; }
        .theme-Water { --accent: #44aaff; }
        .theme-Wind { --accent: #62ffe1; }
        .theme-Earth { --accent: #aa7744; }
        .theme-Light { --accent: #ffffcc; }
        .theme-Shadow { --accent: #bb66ff; }

        .header { padding: 20px 15px; border-bottom: 1px solid #111; flex-shrink: 0; }
        .back-btn { color: #555; text-decoration: none; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; display: inline-block; margin-bottom: 10px; }
        .header-titles h1 { color: #eee; font-size: 1rem; letter-spacing: 4px; margin: 0; text-transform: uppercase; text-align: center; }

        .quest-tabs { display: flex; border-bottom: 1px solid #111; background: #050505; }
        .tab { flex: 1; padding: 12px; text-align: center; font-size: 0.55rem; color: #444; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        .tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); background: rgba(255,255,255,0.02); }

        .quest-list { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .quest-card { background: #0a0a0a; border: 1px solid #1a1a1a; padding: 15px; border-radius: 8px; position: relative; }
        .quest-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .quest-rank { font-size: 0.7rem; font-weight: bold; color: var(--accent); border: 1px solid var(--accent); padding: 2px 6px; border-radius: 4px; }
        .quest-type-tag { font-size: 0.5rem; color: #555; text-transform: uppercase; }
        .quest-title { color: #eee; font-size: 0.8rem; font-weight: bold; margin-bottom: 4px; }
        .quest-desc { color: #777; font-size: 0.6rem; line-height: 1.4; margin-bottom: 12px; }
        .reward-box { background: #050505; border: 1px solid #111; padding: 8px; border-radius: 4px; margin-bottom: 12px; display: flex; flex-wrap: wrap; gap: 10px; }
        .reward-item { font-size: 0.55rem; color: #ffd700; font-family: monospace; }

        .accept-btn { width: 100%; padding: 10px; background: transparent; border: 1px solid #333; color: #eee; font-size: 0.65rem; text-transform: uppercase; cursor: pointer; border-radius: 4px; transition: 0.3s; }
        .accept-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
        .accept-btn:disabled { opacity: 0.2; cursor: not-allowed; }
        .btn-claim { border-color: #ccff00 !important; color: #ccff00 !important; font-weight: bold; box-shadow: 0 0 10px rgba(204, 255, 0, 0.2); }
    </style>
</head>
<body id="bodyTheme">

    <div class="game-window">
        <div class="header">
            <a href="map.html" class="back-btn">‚Üê Back to Hub</a>
            <div class="header-titles"><h1>Quest Log</h1></div>
        </div>

        <div class="quest-tabs">
            <div class="tab active" onclick="filterQuests('main', event)">Main</div>
            <div class="tab" onclick="filterQuests('daily', event)">Daily</div>
        </div>

        <div class="quest-list" id="questContainer"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, runTransaction, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { initSecurity } from "./auth-guard.js";
        import { QUEST_LIBRARY } from "./quest.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCfYnzHzZ82Qdvxsd2U4bSKpDwrQ8g2WuM", 
            authDomain: "sovereigns-of-ruin.firebaseapp.com", 
            projectId: "sovereigns-of-ruin", 
            appId: "1:1098142064736:web:002a76b2e1f8f7b22f6305" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let pData = null;
        let currentTab = 'main';

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await initSecurity(db, auth, user);
                onSnapshot(doc(db, "players", user.uid), (snap) => {
                    if (snap.exists()) {
                        pData = snap.data();
                        document.getElementById('bodyTheme').className = `theme-${pData.element || 'Fire'}`;
                        renderQuests();
                    }
                });
            } else { window.location.href = "index.html"; }
        });

        window.filterQuests = (category, event) => {
            currentTab = category;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderQuests();
        };

        function renderQuests() {
            const container = document.getElementById('questContainer');
            container.innerHTML = "";
            const completedQuests = pData.completedQuests || [];

            const availableQuests = Object.values(QUEST_LIBRARY).filter(q => {
                // 1. Must match category
                if (q.category !== currentTab) return false;
                // 2. Hide completed 'Main' quests
                if (q.category === 'main' && completedQuests.includes(q.id)) return false;
                // 3. Check Prerequisite
                if (q.prerequisiteId && !completedQuests.includes(q.prerequisiteId)) return false;
                
                return true;
            });

            if (availableQuests.length === 0) {
                container.innerHTML = `<div style="text-align:center; color:#333; margin-top:50px; font-size:0.6rem;">NO QUESTS AVAILABLE</div>`;
                return;
            }

            availableQuests.forEach(quest => {
                const isActive = pData.activeQuest && pData.activeQuest.questId === quest.id;
                const isCompleted = isActive && pData.activeQuest.isCompleted;
                const isLevelLocked = pData.level < quest.minLevel;
                const hasOtherActive = pData.activeQuest && !isActive;

                const card = document.createElement('div');
                card.className = "quest-card";
                card.innerHTML = `
                    <div class="quest-header">
                        <span class="quest-type-tag">${quest.type}: ${quest.target}</span>
                        <span class="quest-rank">${quest.rank}</span>
                    </div>
                    <div class="quest-title">${quest.title}</div>
                    <div class="quest-desc">${quest.description}</div>
                    <div class="reward-box">
                        <div class="reward-item">üí∞ ${quest.rewardGold}G</div>
                        <div class="reward-item">‚ú® ${quest.rewardExp}XP</div>
                        ${quest.rewardItem ? `<div class="reward-item">‚öîÔ∏è ${quest.rewardItem.name}</div>` : ''}
                    </div>
                    ${isCompleted ? 
                        `<button class="accept-btn btn-claim" onclick="claimReward('${quest.id}')">CLAIM REWARDS</button>` :
                        `<button class="accept-btn" ${ (isLevelLocked || hasOtherActive || isActive) ? 'disabled' : '' } onclick="acceptQuest('${quest.id}')">
                            ${isActive ? `PROGRESS: ${pData.activeQuest.progress}/${quest.goalAmount}` : 
                              isLevelLocked ? `LEVEL ${quest.minLevel} REQUIRED` : 
                              hasOtherActive ? `FINISH CURRENT BOUNTY` : `ACCEPT QUEST`}
                        </button>`
                    }
                `;
                container.appendChild(card);
            });
        }

        window.acceptQuest = async (questId) => {
            const quest = QUEST_LIBRARY[questId];
            await updateDoc(doc(db, "players", auth.currentUser.uid), {
                activeQuest: {
                    questId: quest.id,
                    progress: 0,
                    goalAmount: quest.goalAmount,
                    isCompleted: false,
                    type: quest.type,
                    target: quest.target,
                    locationId: quest.locationId
                }
            });
        };

        window.claimReward = async (questId) => {
            const quest = QUEST_LIBRARY[questId];
            const playerRef = doc(db, "players", auth.currentUser.uid);

            try {
                await runTransaction(db, async (transaction) => {
                    const snap = await transaction.get(playerRef);
                    const data = snap.data();

                    const newGold = (data.gold || 0) + quest.rewardGold;
                    const newExp = (data.exp || 0) + quest.rewardExp;
                    let inventory = [...(data.inventory || [])];

                    if (quest.rewardItem) {
                        inventory.push({
                            ...quest.rewardItem,
                            uid: "item_" + Date.now(),
                            obtainedAt: new Date().toISOString()
                        });
                    }

                    transaction.update(playerRef, {
                        gold: newGold,
                        exp: newExp,
                        inventory: inventory,
                        activeQuest: null, // Clear active slot
                        completedQuests: arrayUnion(quest.id) // Track completion
                    });
                });
            } catch (e) { console.error("Claim failed: ", e); }
        };
    </script>
</body>
</html>