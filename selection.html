<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Awakening - Sovereigns of Ruin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Mobile-First 400px Container */
        body { background: #000; margin: 0; display: flex; justify-content: center; overflow: hidden; color: #fff; }
        .game-container { 
            width: 400px; height: 100vh; background: #000; 
            display: flex; flex-direction: column; padding: 15px; box-sizing: border-box;
            position: relative; border-left: 1px solid #111; border-right: 1px solid #111;
        }

        .selection-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .element-card {
            background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 10px;
            padding: 20px 10px; cursor: pointer; transition: 0.3s; text-align: center;
        }
        .element-card:hover { border-color: var(--accent); transform: translateY(-3px); background: #111; }
        .element-card.selected { border-color: var(--accent); background: #111; box-shadow: 0 0 15px var(--accent); }
        
        .element-icon { font-size: 2rem; margin-bottom: 10px; display: block; }
        .element-name { font-weight: bold; text-transform: uppercase; letter-spacing: 2px; font-size: 0.75rem; color: #fff; }
        
        #confirmBtn {
            margin-top: 30px; width: 100%; padding: 18px; 
            background: #eee; color: #000; border: none; 
            font-weight: bold; border-radius: 4px; cursor: pointer;
            display: none; letter-spacing: 2px; text-transform: uppercase;
        }

        /* Preview colors for the selection screen */
        .Fire { --accent: #ff4444; }
        .Water { --accent: #44aaff; }
        .Wind { --accent: #62ffe1; }
        .Earth { --accent: #aa7744; }
        .Light { --accent: #ffffcc; }
        .Shadow { --accent: #bb66ff; }

        #loadingOverlay {
            position: fixed; inset: 0; background: #000; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            color: #fff; letter-spacing: 4px; font-size: 0.8rem;
        }
    </style>
</head>
<body id="bodyTheme">

    <div id="loadingOverlay">
        <div>RECOGNIZING SOUL...</div>
    </div>

    <div class="game-container">
        <div style="overflow-y: auto; flex-grow: 1; padding-bottom: 20px;">
            <h2 style="text-align: center; margin-top: 40px; letter-spacing: 4px;">THE AWAKENING</h2>
            <p style="font-size: 0.65rem; color: #555; text-align: center; margin-bottom: 30px; line-height: 1.6; padding: 0 20px;">
                YOUR ESSENCE IS BEING BOUND TO THE VOID. <br>
                <span style="color: #ff4444;">THIS CHOICE IS PERMANENT.</span>
            </p>

            <div class="selection-grid" id="mainGrid">
                <div class="element-card Fire" onclick="selectElement('Fire', this)">
                    <span class="element-icon">ðŸ”¥</span><span class="element-name">Fire</span>
                </div>
                <div class="element-card Water" onclick="selectElement('Water', this)">
                    <span class="element-icon">ðŸ’§</span><span class="element-name">Water</span>
                </div>
                <div class="element-card Wind" onclick="selectElement('Wind', this)">
                    <span class="element-icon">ðŸ’¨</span><span class="element-name">Wind</span>
                </div>
                <div class="element-card Earth" onclick="selectElement('Earth', this)">
                    <span class="element-icon">ðŸŒ¿</span><span class="element-name">Earth</span>
                </div>
                <div class="element-card Light" onclick="selectElement('Light', this)">
                    <span class="element-icon">âœ¨</span><span class="element-name">Light</span>
                </div>
                <div class="element-card Shadow" onclick="selectElement('Shadow', this)">
                    <span class="element-icon">ðŸŒ‘</span><span class="element-name">Shadow</span>
                </div>
            </div>

            <button id="confirmBtn" onclick="awakenSovereign()">AWAKEN AS <span id="selectedLabel">...</span></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCfYnzHzZ82Qdvxsd2U4bSKpDwrQ8g2WuM",
            authDomain: "sovereigns-of-ruin.firebaseapp.com",
            projectId: "sovereigns-of-ruin",
            storageBucket: "sovereigns-of-ruin.firebasestorage.app",
            messagingSenderId: "1098142064736",
            appId: "1:1098142064736:web:002a76b2e1f8f7b22f6305"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let chosenElement = null;
        let userUID = null;
        let isProcessing = false;

        // Starter skill mapping based on chosen element
        const starterSkills = {
            "Fire": "Ember",
            "Water": "Splash",
            "Wind": "Gale",
            "Earth": "Pebble Toss",
            "Light": "Holy Glow",
            "Shadow": "Soul Strike"
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userUID = user.uid;
                const docRef = doc(db, "players", userUID);
                const docSnap = await getDoc(docRef);

                // Check if element is already chosen to prevent re-selection
                if (docSnap.exists() && docSnap.data().element) {
                    window.location.href = "map.html";
                } else {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            } else {
                window.location.href = "index.html";
            }
        });

        window.selectElement = (el, card) => {
            if (isProcessing) return;
            chosenElement = el;
            document.querySelectorAll('.element-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            document.getElementById('selectedLabel').innerText = el.toUpperCase();
            document.getElementById('confirmBtn').style.display = 'block';
            document.getElementById('bodyTheme').className = el;
        };

        window.awakenSovereign = async () => {
            if (!chosenElement || !userUID || isProcessing) return;

            isProcessing = true;
            const btn = document.getElementById('confirmBtn');
            btn.disabled = true;
            btn.innerText = "BINDING SOUL...";
            
            const newSessionId = Math.random().toString(36).substring(7);
            localStorage.setItem('currentSessionId', newSessionId);

            try {
                // Initialize skills: index 0 is the starter skill, others are empty (null)
                const initialSkills = [starterSkills[chosenElement], null, null, null];

                await updateDoc(doc(db, "players", userUID), {
                    element: chosenElement,
                    activeSessionId: newSessionId,
                    level: 0, 
                    trainingLevels: { maxHp: 0, maxMana: 0 },
                    shards: 0,
                    gold: 0,
                    skills: initialSkills,
                    inventory: []
                });

                window.location.href = "map.html";
            } catch (error) {
                console.error("Ritual failed:", error);
                alert("The void rejected the binding. Check connection.");
                isProcessing = false;
                btn.disabled = false;
                btn.innerText = "RETRY AWAKENING";
            }
        };
    </script>
</body>
</html>