<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arcane Sanctum - Sovereigns of Ruin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { background: #000; margin: 0; display: flex; justify-content: center; height: 100dvh; overflow: hidden; font-family: sans-serif; }
        
        .game-window {
            width: 400px;
            height: 100dvh;
            background: #000;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #111;
            border-right: 1px solid #111;
        }

        .top-nav { padding: 15px 20px; border-bottom: 1px solid #111; flex-shrink: 0; }
        .back-link { color: #444; text-decoration: none; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 2px; font-weight: bold; transition: 0.2s; }
        .back-link:hover { color: var(--accent, #bb66ff); }

        .shop-header { padding: 20px 15px; text-align: center; flex-shrink: 0; }
        .shop-header h1 { color: var(--accent, #bb66ff); font-size: 1rem; letter-spacing: 4px; margin: 0; text-transform: uppercase; }
        .shop-header p { color: #444; font-size: 0.5rem; letter-spacing: 1px; margin-top: 5px; text-transform: uppercase; }

        .element-tabs {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 10px;
            border-bottom: 1px solid #111;
        }
        .tab { opacity: 0.3; cursor: pointer; font-size: 1.2rem; transition: 0.3s; filter: grayscale(1); }
        .tab.active { opacity: 1; transform: scale(1.2); filter: grayscale(0) drop-shadow(0 0 8px var(--accent)); }

        .spell-list {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .spell-card {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .spell-info { flex-grow: 1; }
        .spell-name { display: block; color: #eee; font-size: 0.8rem; font-weight: bold; }
        .spell-desc { display: block; color: #555; font-size: 0.55rem; margin-top: 4px; text-transform: uppercase; }

        .buy-btn {
            background: none;
            border: 1px solid #333;
            color: #ffcc00;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .buy-btn:hover { border-color: #ffcc00; background: #111; }

        .shop-footer { padding: 15px 20px; border-top: 1px solid #111; display: flex; justify-content: flex-start; align-items: center; background: #050505; }
        .gold-display { color: #ffcc00; font-weight: bold; font-size: 0.8rem; letter-spacing: 1px; }

        /* THEMES */
        .theme-Fire { --accent: #ff4444; }
        .theme-Water { --accent: #44aaff; }
        .theme-Wind { --accent: #62ffe1; }
        .theme-Earth { --accent: #aa7744; }
        .theme-Light { --accent: #ffffcc; }
        .theme-Shadow { --accent: #bb66ff; }
    </style>
</head>
<body id="bodyTheme">

    <div class="game-window">
        <div class="top-nav">
            <a href="market-hub.html" class="back-link">‚Üê Market District</a>
        </div>

        <div class="shop-header">
            <h1 id="shopTitle">Arcane Sanctum</h1>
            <p>Ancient Manuscripts & Abilities</p>
        </div>

        <div class="element-tabs" id="tabContainer">
            <span class="tab active" data-element="Fire">üî•</span>
            <span class="tab" data-element="Water">üíß</span>
            <span class="tab" data-element="Wind">üåø</span>
            <span class="tab" data-element="Earth">ü™®</span>
            <span class="tab" data-element="Light">‚òÄÔ∏è</span>
            <span class="tab" data-element="Shadow">üåë</span>
        </div>

        <div class="spell-list" id="spellList"></div>

        <div class="shop-footer">
            <div class="gold-display">GOLD: <span id="pGold">----</span></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { initSecurity } from "./auth-guard.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCfYnzHzZ82Qdvxsd2U4bSKpDwrQ8g2WuM", 
            authDomain: "sovereigns-of-ruin.firebaseapp.com", 
            projectId: "sovereigns-of-ruin", 
            storageBucket: "sovereigns-of-ruin.firebasestorage.app", 
            messagingSenderId: "1098142064736", 
            appId: "1:1098142064736:web:002a76b2e1f8f7b22f6305" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Spell Icons mapping for Inventory consistency
        const spellIcons = {
            'Fireball': 'üî•', 'Inferno Blast': 'üí•',
            'Tidal Wave': 'üåä', 'Frost Bite': '‚ùÑÔ∏è',
            'Gale Blade': 'üå™Ô∏è', 'Cyclone Step': 'üí®',
            'Stone Skin': 'üõ°Ô∏è', 'Quake': 'üåã',
            'Heal': '‚ú®', 'Purge': '‚òÄÔ∏è',
            'Void Bolt': 'üîÆ', 'Soul Reap': 'üíÄ'
        };

        const spells = {
            Fire: [
                { id: 'f1', name: 'Fireball', cost: 300, desc: '20 Mana | Launch a sphere of flame.' },
                { id: 'f2', name: 'Inferno Blast', cost: 1200, desc: '55 Mana | Eruption of high-temp mana.' }
            ],
            Water: [
                { id: 'w1', name: 'Tidal Wave', cost: 400, desc: '25 Mana | Crushing wave of spirit water.' },
                { id: 'w2', name: 'Frost Bite', cost: 900, desc: '40 Mana | Freeze blood flow in targets.' }
            ],
            Wind: [
                { id: 'v1', name: 'Gale Blade', cost: 350, desc: '15 Mana | Razor sharp wind pressure.' },
                { id: 'v2', name: 'Cyclone Step', cost: 1500, desc: '60 Mana | Teleport through air currents.' }
            ],
            Earth: [
                { id: 'e1', name: 'Stone Skin', cost: 500, desc: '30 Mana | Harden skin like granite.' },
                { id: 'e2', name: 'Quake', cost: 2000, desc: '80 Mana | Shatter the ground beneath.' }
            ],
            Light: [
                { id: 'l1', name: 'Heal', cost: 600, desc: '35 Mana | Restore minor health wounds.' },
                { id: 'l2', name: 'Purge', cost: 1800, desc: '70 Mana | Cleanse all status ailments.' }
            ],
            Shadow: [
                { id: 's1', name: 'Void Bolt', cost: 700, desc: '40 Mana | Bolt of pure nothingness.' },
                { id: 's2', name: 'Soul Reap', cost: 2500, desc: '100 Mana | Drain life from the fallen.' }
            ]
        };

        let currentElement = "Fire";

        function renderSpells(element) {
            const list = document.getElementById('spellList');
            list.innerHTML = '';
            
            spells[element].forEach(spell => {
                const card = document.createElement('div');
                card.className = 'spell-card';
                card.innerHTML = `
                    <div class="spell-info">
                        <span class="spell-name">${spell.name}</span>
                        <span class="spell-desc">${spell.desc}</span>
                    </div>
                    <button class="buy-btn" onclick="purchaseSpell('${spell.id}', ${spell.cost}, '${spell.name}', '${spell.desc}')">${spell.cost} G</button>
                `;
                list.appendChild(card);
            });
        }

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentElement = tab.getAttribute('data-element');
                renderSpells(currentElement);
            });
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await initSecurity(db, auth, user);
                onSnapshot(doc(db, "players", user.uid), (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        document.getElementById('pGold').innerText = data.gold;
                        document.getElementById('bodyTheme').className = `theme-${data.element}`;
                    }
                });
                renderSpells("Fire");
            } else {
                window.location.href = "index.html";
            }
        });

        window.purchaseSpell = async (id, cost, name, desc) => {
            const user = auth.currentUser;
            const playerRef = doc(db, "players", user.uid);
            const snap = await getDoc(playerRef);
            const data = snap.data();

            // Check if already owned (must check name inside objects now)
            const inventory = data.inventory || [];
            const isOwned = inventory.some(item => typeof item === 'object' && item.name === name);

            if (data.gold >= cost) {
                if (isOwned) {
                    alert("This manuscript is already in your possession.");
                    return;
                }
                
                await updateDoc(playerRef, {
                    gold: data.gold - cost,
                    inventory: arrayUnion({
                        itemId: id,
                        name: name,
                        type: 'manuscript', // Categorizes it for the 'Arcane' tab in inventory
                        stats: desc.split('|')[0].trim(), // Grabs the "Mana" requirement
                        icon: spellIcons[name] || 'üìú',
                        acquiredAt: new Date().toISOString()
                    })
                });
                alert(`Manuscript Acquired: ${name}`);
            } else {
                alert("Insufficient Gold!");
            }
        };
    </script>
</body>
</html>