<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arcane Sanctum - Sovereigns of Ruin</title>
    <style>
        body { background: #000; margin: 0; display: flex; justify-content: center; height: 100dvh; overflow: hidden; font-family: 'Inter', sans-serif; }
        
        .game-window {
            width: 400px;
            height: 100dvh;
            background: #000;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #111;
            border-right: 1px solid #111;
        }

        .top-nav { padding: 15px 20px; border-bottom: 1px solid #111; flex-shrink: 0; }
        .back-link { color: #444; text-decoration: none; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 2px; font-weight: bold; transition: 0.2s; }
        .back-link:hover { color: var(--accent, #bb66ff); }

        .shop-header { padding: 20px 15px; text-align: center; flex-shrink: 0; }
        .shop-header h1 { color: var(--accent, #bb66ff); font-size: 1rem; letter-spacing: 4px; margin: 0; text-transform: uppercase; }
        .shop-header p { color: #444; font-size: 0.5rem; letter-spacing: 1px; margin-top: 5px; text-transform: uppercase; }

        .element-tabs {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 10px;
            border-bottom: 1px solid #111;
        }
        .tab { opacity: 0.3; cursor: pointer; font-size: 1.2rem; transition: 0.3s; filter: grayscale(1); }
        .tab.active { opacity: 1; transform: scale(1.2); filter: grayscale(0) drop-shadow(0 0 8px var(--accent)); }

        .spell-list {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .spell-card {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .spell-icon { font-size: 1.5rem; margin-right: 15px; }
        .spell-info { flex-grow: 1; }
        .spell-name { display: block; color: #eee; font-size: 0.8rem; font-weight: bold; }
        .spell-desc { display: block; color: #555; font-size: 0.55rem; margin-top: 4px; text-transform: uppercase; }

        .buy-btn {
            background: none;
            border: 1px solid #333;
            color: #ffcc00;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .buy-btn:hover:not(:disabled) { border-color: #ffcc00; background: #111; }
        .buy-btn:disabled { opacity: 0.4; color: #444; cursor: not-allowed; border-color: #222; }

        .shop-footer { padding: 15px 20px; border-top: 1px solid #111; display: flex; justify-content: flex-start; align-items: center; background: #050505; }
        .gold-display { color: #ffcc00; font-weight: bold; font-size: 0.8rem; letter-spacing: 1px; }

        .theme-Fire { --accent: #ff4444; }
        .theme-Water { --accent: #44aaff; }
        .theme-Wind { --accent: #62ffe1; }
        .theme-Earth { --accent: #aa7744; }
        .theme-Light { --accent: #ffffcc; }
        .theme-Shadow { --accent: #bb66ff; }
    </style>
</head>
<body id="bodyTheme">

    <div class="game-window">
        <div class="top-nav">
            <a href="market-hub.html" class="back-link">‚Üê Market District</a>
        </div>

        <div class="shop-header">
            <h1 id="shopTitle">Arcane Sanctum</h1>
            <p>Ancient Manuscripts & Abilities</p>
        </div>

        <div class="element-tabs" id="tabContainer">
            <span class="tab active" data-element="Fire">üî•</span>
            <span class="tab" data-element="Water">üíß</span>
            <span class="tab" data-element="Wind">üí®</span>
            <span class="tab" data-element="Earth">üåø</span>
            <span class="tab" data-element="Light">‚ú®</span>
            <span class="tab" data-element="Shadow">üåë</span>
        </div>

        <div class="spell-list" id="spellList"></div>

        <div class="shop-footer">
            <div class="gold-display">GOLD: <span id="pGold">----</span></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { initSecurity } from "./auth-guard.js";
        import { ITEM_LIBRARY, getItemsByStore } from "./items.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCfYnzHzZ82Qdvxsd2U4bSKpDwrQ8g2WuM", 
            authDomain: "sovereigns-of-ruin.firebaseapp.com", 
            projectId: "sovereigns-of-ruin", 
            appId: "1:1098142064736:web:002a76b2e1f8f7b22f6305" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentElement = "Fire";
        let playerData = null;
        const ALL_SPELLS = getItemsByStore('arcane_sanctum');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await initSecurity(db, auth, user);
                onSnapshot(doc(db, "players", user.uid), (snap) => {
                    if (snap.exists()) {
                        playerData = snap.data();
                        document.getElementById('pGold').innerText = playerData.gold;
                        document.getElementById('bodyTheme').className = `theme-${playerData.element}`;
                        renderSpells(currentElement);
                    }
                });
            } else {
                window.location.href = "index.html";
            }
        });

        // Check if spell is already in Skills OR Inventory
        function isSpellOwned(spellId) {
            if (!playerData) return false;
            const inSkills = (playerData.skills || []).includes(spellId);
            const inInventory = (playerData.inventory || []).some(item => item.id === spellId);
            return inSkills || inInventory;
        }

        function renderSpells(element) {
            const list = document.getElementById('spellList');
            list.innerHTML = '';
            
            const filtered = ALL_SPELLS.filter(s => s.element === element);

            filtered.forEach(spell => {
                const owned = isSpellOwned(spell.id);
                const card = document.createElement('div');
                card.className = 'spell-card';
                card.innerHTML = `
                    <div class="spell-icon">${spell.emoji}</div>
                    <div class="spell-info">
                        <span class="spell-name">${spell.name}</span>
                        <span class="spell-desc">${spell.manaCost} Mana | Power: ${spell.baseStat}</span>
                    </div>
                    <button class="buy-btn" 
                        onclick="window.purchaseSpell('${spell.id}')" 
                        ${owned ? 'disabled' : ''}>
                        ${owned ? 'LEARNED' : spell.price + ' G'}
                    </button>
                `;
                list.appendChild(card);
            });
        }

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentElement = tab.getAttribute('data-element');
                renderSpells(currentElement);
            });
        });

        window.purchaseSpell = async (spellId) => {
            const spell = ITEM_LIBRARY[spellId];
            if (!playerData || !spell) return;

            if (isSpellOwned(spellId)) {
                alert("You already possess this knowledge.");
                return;
            }

            if (playerData.gold < spell.price) {
                alert("The Sanctum requires more gold for this knowledge.");
                return;
            }

            const currentSkills = [...(playerData.skills || [])];
            const emptySlotIndex = currentSkills.indexOf(null);

            if (emptySlotIndex === -1) {
                alert("Your soul can only bind 4 active skills. Visit the Skill Manager to forget one.");
                return;
            }

            currentSkills[emptySlotIndex] = spellId;

            try {
                const playerRef = doc(db, "players", auth.currentUser.uid);
                await updateDoc(playerRef, {
                    gold: playerData.gold - spell.price,
                    skills: currentSkills,
                    inventory: arrayUnion({
                        id: spell.id,
                        name: spell.name,
                        type: 'manuscript',
                        emoji: spell.emoji,
                        acquiredAt: new Date().toISOString()
                    })
                });
                alert(`Knowledge Obtained: ${spell.name}`);
            } catch (err) {
                console.error("Binding failed:", err);
            }
        };
    </script>
</body>
</html>