<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Threshold of Souls - Combat</title>
    <style>
        :root { 
            --teal: #62ffe1; --red: #ff4444; --gold: #ffcc00; 
            --bg: #050505; --mana: #22ccff; --xp: #bb66ff; 
        }
        body { 
            background: #000; margin: 0; display: flex; justify-content: center; 
            height: 100dvh; font-family: 'Inter', sans-serif; overflow: hidden; color: #eee; 
        }
        
        .scene { 
            width: 400px; height: 100dvh; position: relative; 
            display: flex; flex-direction: column; background: var(--bg); 
            border-left: 1px solid #111; border-right: 1px solid #111; 
        }

        /* Top Header Line */
        .top-nav { 
            padding: 10px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid var(--red);
        }

        /* Enemy Display Area */
        .combat-area { 
            padding: 15px 0;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
        }

        /* Battle Log (Yellow Box - Shrunk and Fixed) */
        .log-area { 
            height: 100px; 
            background: #020202; 
            padding: 10px 15px; 
            font-size: 0.75rem; 
            overflow-y: auto; 
            font-family: monospace; 
            border-top: 1px solid #111;
            border-bottom: 1px solid #111;
        }

        /* Stats & Actions (Blue Box - Moved up) */
        .footer-ui { 
            padding: 15px; 
            background: #080808; 
            flex-grow: 0; 
        }

        /* Footer Line Thingy at the end of the action area */
        .action-bottom-line {
            border-bottom: 2px solid #1a1a1a;
            margin-top: 10px;
            width: 100%;
        }

        .btn { background: #0c0c0c; border: 1px solid #252525; color: var(--teal); padding: 12px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; cursor: pointer; width: 100%; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .bar-wrap { width: 100%; height: 8px; background: #111; border: 1px solid #222; margin: 4px 0; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.3s ease; }

        /* GOD MODE STYLES */
        #godMenu { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.98); z-index: 1000; display: none; 
            padding: 20px; box-sizing: border-box; 
            border: 2px solid var(--gold); 
            overflow-y: auto;
        }
        .god-card { background: #111; border: 1px solid #222; padding: 10px; margin-bottom: 10px; border-radius: 4px; }
        .god-row { display: flex; gap: 8px; margin: 4px 0; }
        .god-btn { background: #1a1a1a; border: 1px solid #333; color: #eee; padding: 10px; font-size: 0.65rem; cursor: pointer; text-transform: uppercase; font-weight: bold; width: 100%; }
    </style>
</head>
<body>

<div class="scene" id="mainScene">
    <div id="godMenu">
        <div style="color:var(--gold); text-align:center; font-weight:900; margin-bottom:15px;">DIVINE CONSOLE</div>
        
        <div class="god-card" id="godStatsDisplay"></div>

        <div class="god-card">
            <div style="font-size: 0.6rem; color: var(--teal); margin-bottom: 5px;">MONSTER SPAWNER</div>
            <div class="god-row">
                <select id="godMonsterSelect" style="flex: 2; background: #000; color: #fff; border: 1px solid #444; font-size: 0.7rem;"></select>
                <button id="godSpawnBtn" class="god-btn" style="flex: 1; border-color: var(--teal);">SPAWN</button>
            </div>
        </div>

        <div class="god-card">
            <button class="god-btn" id="godHeal" style="color:var(--teal); margin-bottom:8px;">Instant Restore</button>
            <div class="god-row">
                <button class="god-btn" id="godLevelUp" style="color:var(--gold)">Level +1</button>
                <button class="god-btn" id="godLevelDown">Level -1</button>
            </div>
            <div class="god-row">
                <button class="god-btn" id="godAddGold">+5K Gold</button>
                <button class="god-btn" id="godSubGold">-5K Gold</button>
            </div>
        </div>
        
        <button class="god-btn" id="godHardReset" style="background:#400; border-color:var(--red); color:white; margin-top:10px;">Hard Player Reset</button>
        <button class="god-btn" id="closeGod" style="border-color:#555; margin-top:20px;">Exit Console</button>
    </div>

    <div class="top-nav">
        <div id="retreatLink" style="color: var(--teal); cursor: pointer; font-size: 0.7rem;">‚Üê RETREAT</div>
        <div id="mapTitle" style="font-size: 0.7rem; font-weight: bold; cursor: pointer;">THRESHOLD OF SOULS</div>
        <div id="pLevel" style="color: var(--teal); font-weight: bold;">LVL --</div>
    </div>

    <div class="combat-area">
        <div id="mSprite" style="font-size: 3rem; margin-bottom: 5px;">üåë</div>
        <div id="mName" style="font-size: 0.7rem; font-weight: bold; text-transform: uppercase; margin-bottom: 5px;">Searching...</div>
        <div class="bar-wrap" style="width: 50%;"><div id="mHPFill" class="bar-fill" style="background: var(--red);"></div></div>
        <div id="mHPText" style="font-size: 0.55rem; color: #666;">0 / 0</div>
    </div>

    <div class="log-area" id="combatLog">
        <div>> System online.</div>
    </div>

    <div class="footer-ui">
        <div style="margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; font-size: 0.6rem; color: var(--red);"><span>HP</span><span id="pHPText">0/0</span></div>
            <div class="bar-wrap"><div id="pHPFill" class="bar-fill" style="background: var(--red);"></div></div>
            
            <div style="display: flex; justify-content: space-between; font-size: 0.6rem; color: var(--mana); margin-top: 5px;"><span>MP</span><span id="pMPText">0/0</span></div>
            <div class="bar-wrap"><div id="pMPFill" class="bar-fill" style="background: var(--mana);"></div></div>
            
            <div class="bar-wrap" style="height: 4px; margin-top:5px;"><div id="pXPFill" class="bar-fill" style="background: var(--xp);"></div></div>
        </div>

        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
            <button id="atkBtn" class="btn" disabled>Standard Attack</button>
            <button id="skillBtn" class="btn" disabled>Start Shadow (15MP)</button>
        </div>

        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
            <button id="useHPPot" class="btn" style="color:var(--red); padding: 8px; font-size:0.6rem;">HP POT (0)</button>
            <button id="useMPPot" class="btn" style="color:var(--mana); padding: 8px; font-size:0.6rem;">MP POT (0)</button>
        </div>

        <button id="spawnBtn" class="btn" style="border-color: var(--teal);">Explore Floor</button>
        
        <div class="action-bottom-line"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    import { GodMode } from "./Godmode.js";
    import { CombatEngine } from "./battle.js";
    import { calculateCombatResult, getRequiredXP } from "./system.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCfYnzHzZ82Qdvxsd2U4bSKpDwrQ8g2WuM", 
        authDomain: "sovereigns-of-ruin.firebaseapp.com", 
        projectId: "sovereigns-of-ruin" 
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let player = null;

    onAuthStateChanged(auth, (user) => {
        if (!user) { window.location.href = "login.html"; return; }
        onSnapshot(doc(db, "players", user.uid), (snap) => {
            if (!snap.exists()) return;
            player = snap.data();
            GodMode.init(player, db, auth);
            CombatEngine.init(player, db, auth, {
                update: updateUI,
                addLog: (msg, color) => {
                    const log = document.getElementById('combatLog');
                    if(log) {
                        log.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
                        log.scrollTop = log.scrollHeight;
                    }
                },
                clearLog: () => { 
                    const log = document.getElementById('combatLog');
                    if(log) log.innerHTML = ""; 
                },
                onDeath: () => { window.location.href = "wildlands.html"; }
            });
            updateUI();
        });
    });

    function updateUI() {
        if (!player) return;
        document.getElementById('pLevel').innerText = `LVL ${player.level}`;
        document.getElementById('pHPText').innerText = `${Math.floor(player.stats.hp)} / ${player.stats.maxHp}`;
        document.getElementById('pHPFill').style.width = `${(player.stats.hp / player.stats.maxHp) * 100}%`;
        document.getElementById('pMPText').innerText = `${Math.floor(player.stats.mana)} / ${player.stats.maxMana}`;
        document.getElementById('pMPFill').style.width = `${(player.stats.mana / player.stats.maxMana) * 100}%`;
        document.getElementById('pXPFill').style.width = `${(player.exp / getRequiredXP(player.level)) * 100}%`;

        const hpCount = player.inventory?.filter(i => i.id === 'hp_pot').length || 0;
        const mpCount = player.inventory?.filter(i => i.id === 'mp_pot').length || 0;
        
        const hpBtn = document.getElementById('useHPPot');
        hpBtn.innerText = `HP POT (${hpCount})`;
        hpBtn.disabled = (hpCount <= 0 || player.stats.hp >= player.stats.maxHp);

        const mpBtn = document.getElementById('useMPPot');
        mpBtn.innerText = `MP POT (${mpCount})`;
        mpBtn.disabled = (mpCount <= 0 || player.stats.mana >= player.stats.maxMana);

        const m = CombatEngine.monster;
        if (m) {
            document.getElementById('mName').innerText = `${m.name} (Lvl ${m.level})`;
            document.getElementById('mSprite').innerText = m.emoji || "üëπ";
            document.getElementById('mHPFill').style.width = `${(m.curHp / m.hp) * 100}%`;
            document.getElementById('mHPText').innerText = `${Math.floor(m.curHp)} / ${m.hp}`;
            
            document.getElementById('atkBtn').disabled = CombatEngine.isBusy;
            document.getElementById('skillBtn').disabled = (CombatEngine.isBusy || player.stats.mana < 15);
            document.getElementById('spawnBtn').style.display = "none";
        } else {
            document.getElementById('mName').innerText = "Searching...";
            document.getElementById('mSprite').innerText = "üåë";
            document.getElementById('mHPFill').style.width = "0%";
            document.getElementById('spawnBtn').style.display = "block";
            document.getElementById('spawnBtn').innerText = "Explore Floor";
            document.getElementById('atkBtn').disabled = true;
            document.getElementById('skillBtn').disabled = true;
        }
    }

    async function usePotion(type) {
        if (!player) return;
        const potId = type === 'HP' ? 'hp_pot' : 'mp_pot';
        const potIndex = player.inventory.findIndex(i => i.id === potId);
        
        if (potIndex > -1) {
            player.inventory.splice(potIndex, 1);
            if (type === 'HP') {
                player.stats.hp = Math.min(player.stats.maxHp, player.stats.hp + 50);
                CombatEngine.ui.addLog("Used HP Potion! +50 HP", "var(--red)");
            } else {
                player.stats.mana = Math.min(player.stats.maxMana, player.stats.mana + 30);
                CombatEngine.ui.addLog("Used MP Potion! +30 Mana", "var(--mana)");
            }
            await updateDoc(doc(db, "players", auth.currentUser.uid), {
                inventory: player.inventory,
                stats: player.stats
            });
        }
    }

    document.getElementById('mapTitle').onclick = () => GodMode.handleTrigger();
    document.getElementById('retreatLink').onclick = () => window.location.href = "wildlands.html";
    document.getElementById('spawnBtn').onclick = () => CombatEngine.spawn("THRESHOLD_OF_SOULS");
    document.getElementById('atkBtn').onclick = () => CombatEngine.playerAttack(calculateCombatResult);
    document.getElementById('skillBtn').onclick = () => CombatEngine.useSkill("Start Shadow", calculateCombatResult);
    document.getElementById('useHPPot').onclick = () => usePotion('HP');
    document.getElementById('useMPPot').onclick = () => usePotion('MP');
    
</script>
</body>
</html>