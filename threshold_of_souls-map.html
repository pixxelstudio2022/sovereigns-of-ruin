<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Threshold of Souls - Combat</title>
    <style>
        :root { --teal: #62ffe1; --red: #ff4444; --gold: #ffcc00; --bg: #050505; --mana: #22ccff; }
        body { background: #000; margin: 0; display: flex; justify-content: center; height: 100dvh; font-family: 'Inter', sans-serif; overflow: hidden; color: #eee; }
        
        .scene { 
            width: 400px; 
            height: 100dvh; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            background: #050505; 
            border-left: 1px solid #111; 
            border-right: 1px solid #111;
        }

        /* GOD MENU STYLES */
        #godMenu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000; display: none;
            padding: 20px; box-sizing: border-box; overflow-y: auto;
            border: 1px solid var(--gold);
        }
        .god-header { color: var(--gold); font-size: 0.9rem; font-weight: 900; text-align: center; margin-bottom: 15px; letter-spacing: 2px; }
        .god-card { background: #111; border: 1px solid #222; padding: 10px; margin-bottom: 10px; border-radius: 4px; }
        .god-label { font-size: 0.55rem; color: #666; text-transform: uppercase; display: block; margin-bottom: 4px; }
        .god-stat { font-size: 0.75rem; color: #fff; margin-bottom: 2px; }
        .god-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px; }
        .god-btn { 
            background: #1a1a1a; border: 1px solid #333; color: #eee; padding: 8px 4px; 
            font-size: 0.6rem; cursor: pointer; text-transform: uppercase; font-weight: bold;
        }
        .god-btn:active { background: var(--teal); color: #000; }
        .god-reset { background: #300; border-color: #600; color: #ff4444; margin-top: 15px; width: 100%; }

        /* DEATH OVERLAY */
        #deathOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #1a0000 0%, #000 80%);
            display: none; z-index: 999; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
            animation: fadeInDeath 2s forwards;
        }
        .death-text { color: #ff0000; font-size: 1.4rem; font-weight: 900; letter-spacing: 4px; text-transform: uppercase; text-shadow: 0 0 25px rgba(255, 0, 0, 0.9); margin-bottom: 15px; }
        .death-subtitle { color: #666; font-size: 0.75rem; font-style: italic; max-width: 80%; line-height: 1.4; }
        @keyframes fadeInDeath { from { opacity: 0; background: #000; } to { opacity: 1; } }

        /* UI ELEMENTS */
        .top-nav { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; background: #000; border-bottom: 1px solid #1a1a1a; }
        .map-title { font-size: 0.65rem; font-weight: 800; letter-spacing: 2px; color: #fff; text-transform: uppercase; cursor: pointer; }
        .monster-area { padding: 15px 0; display: flex; flex-direction: column; align-items: center; background: radial-gradient(circle at center, #0a0a0a 0%, #050505 100%); }
        .monster-sprite { font-size: 3.5rem; margin-bottom: 8px; filter: drop-shadow(0 0 10px rgba(98, 255, 225, 0.2)); }
        .combat-log { height: 100px; padding: 10px 15px; font-size: 0.65rem; color: #888; overflow-y: auto; font-family: 'monospace'; background: #020202; line-height: 1.5; border-top: 1px solid #111; border-bottom: 1px solid #111; }
        .player-footer { background: #080808; padding: 12px 15px; }
        .footer-line { height: 2px; background: #111; border-bottom: 1px solid #1a1a1a; margin-bottom: 12px; }
        .player-status-row { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
        .bar-wrap { width: 100%; height: 8px; background: #111; border: 1px solid #222; position: relative; overflow: hidden; border-radius: 1px; }
        .mini-bar { flex: 1; }
        .bar-fill { height: 100%; transition: width 0.3s ease; }
        .hp-fill { background: var(--red); }
        .mp-fill { background: var(--mana); }
        .grid-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .btn { background: #0c0c0c; border: 1px solid #252525; color: var(--teal); padding: 12px 5px; font-size: 0.6rem; font-weight: 800; cursor: pointer; border-radius: 3px; text-transform: uppercase; }
        .btn:active { background: var(--teal); color: #000; }
        .btn:disabled { opacity: 0.15; pointer-events: none; }
        .shake { animation: shake 0.15s ease-in-out infinite; }
        @keyframes shake { 0% { transform: translate(0, 0); } 25% { transform: translate(6px, -3px); } 50% { transform: translate(-6px, 3px); } 75% { transform: translate(6px, 3px); } 100% { transform: translate(0, 0); } }
    </style>
</head>
<body>

<div class="scene" id="mainScene">
    <div id="godMenu">
        <div class="god-header">ADMIN COMMAND CENTER</div>
        <div class="god-card">
            <span class="god-label">Vitality & Stats</span>
            <div class="god-stat" id="g-hp-mp">HP: 0 | MP: 0</div>
            <div class="god-stat" id="g-base">Base Atk: 0 | Def: 0</div>
            <div class="god-stat" id="g-gear" style="color:var(--teal)">Gear Boost: +0 Atk | +0 Def</div>
            <button class="god-btn" style="width:100%; margin-top:8px; color:var(--teal)" onclick="godRestore()">Restore HP/MP</button>
        </div>
        <div class="god-card">
            <span class="god-label">Skill List</span>
            <div id="g-spells" style="font-size:0.6rem; color:var(--mana); line-height:1.2;">-</div>
        </div>
        <div class="god-card">
            <span class="god-label">Adjustments</span>
            <div class="god-grid">
                <button class="god-btn" onclick="godGold(500)">+500 Gold</button>
                <button class="god-btn" onclick="godGold(-500)">-500 Gold</button>
                <button class="god-btn" onclick="godLevel(1)">Level +1</button>
                <button class="god-btn" onclick="godLevel(-1)">Level -1</button>
            </div>
        </div>
        <button class="god-btn god-reset" onclick="godReset()">HARD RESET PROFILE</button>
        <button class="god-btn" style="width:100%; margin-top:10px;" onclick="closeGodMenu()">Close God Menu</button>
    </div>

    <div id="deathOverlay">
        <div id="deathContent">
            <div class="death-text">YOUR SOUL IS MINE...</div>
            <div class="death-subtitle">Hahahaha... another failure for the abyss.</div>
        </div>
    </div>

    <div class="top-nav">
        <a href="wildlands.html" style="color:var(--teal); text-decoration:none; font-size:0.6rem; font-weight:bold;">‚Üê RETREAT</a>
        <span class="map-title" onclick="godTrigger()">Threshold of Souls</span>
        <span id="pLevel" style="color:var(--teal); font-size:0.7rem; font-weight:bold;">LVL --</span>
    </div>

    <div class="monster-area">
        <div id="mSprite" class="monster-sprite">üåë</div>
        <div id="mMeta" style="font-size:0.6rem; color:#aaa; margin-bottom:5px; text-transform:uppercase; font-weight:bold;">SEARCHING...</div>
        <div class="bar-wrap" style="width: 200px; height: 12px;">
            <div id="mHPFill" class="bar-fill hp-fill" style="width:0%"></div>
        </div>
        <div id="mHPText" style="font-size: 0.55rem; margin-top: 4px; font-weight: bold; color: var(--red);">---</div>
    </div>

    <div class="combat-log" id="log">
        <div style="color:var(--teal)">> System online.</div>
    </div>

    <div class="player-footer">
        <div class="player-status-row">
            <div style="font-size: 0.5rem; color: var(--red); font-weight: bold; width: 20px;">HP</div>
            <div class="bar-wrap mini-bar"><div id="pHPFill" class="bar-fill hp-fill" style="width: 100%"></div></div>
            <div style="font-size: 0.5rem; color: var(--mana); font-weight: bold; width: 20px; margin-left: 10px;">MP</div>
            <div class="bar-wrap mini-bar"><div id="pMPFill" class="bar-fill mp-fill" style="width: 100%"></div></div>
        </div>
        <div class="footer-line"></div>
        <div class="grid-buttons" id="abilityContainer" style="margin-bottom: 6px;">
            <button class="btn" id="atkBtn" onclick="attack()" disabled>Standard Attack</button>
            <button class="btn" id="skillBtn" onclick="useSkill()" disabled>Skill</button>
        </div>
        <div class="grid-buttons">
            <button class="btn" style="color:var(--red)" onclick="usePotion('7')">HP POT (<span id="hpCount">0</span>)</button>
            <button class="btn" style="color:var(--mana)" onclick="usePotion('8')">MP POT (<span id="mpCount">0</span>)</button>
            <button id="nextBtn" class="btn" style="grid-column: span 2; border-color:var(--teal); color: #fff; margin-top: 4px;" onclick="attemptSpawn()">Explore Floor</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { initSecurity } from "./auth-guard.js";
    import { MONSTER_DATABASE } from "./monsters.js";
    import { ITEM_LIBRARY } from "./items.js"; 
    import { calculateCombatResult, rollRange, processLevelUp } from "./system.js";

    const firebaseConfig = { apiKey: "AIzaSyCfYnzHzZ82Qdvxsd2U4bSKpDwrQ8g2WuM", authDomain: "sovereigns-of-ruin.firebaseapp.com", projectId: "sovereigns-of-ruin", appId: "1:1098142064736:web:002a76b2e1f8f7b22f6305" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ADMIN_UID = "v6M5KflMjQam6M9LUeZym666fKw1";
    let pData = null;
    let monster = null;
    let isBusy = false;
    let godClicks = 0;

    onAuthStateChanged(auth, async (user) => {
        if (!user) return;
        await initSecurity(db, auth, user);
        onSnapshot(doc(db, "players", user.uid), (snap) => {
            if (!snap.exists()) return;
            pData = snap.data();
            updateUI();
            if(document.getElementById('godMenu').style.display === 'block') refreshGodMenu();
        });
    });

    // --- GOD MENU LOGIC ---
    window.godTrigger = function() {
        if(auth.currentUser?.uid !== ADMIN_UID) return;
        godClicks++;
        if(godClicks >= 5) {
            document.getElementById('godMenu').style.display = 'block';
            refreshGodMenu();
            godClicks = 0;
        }
    };

    window.closeGodMenu = () => document.getElementById('godMenu').style.display = 'none';

    function refreshGodMenu() {
        if(!pData) return;
        let gearAtk = 0, gearDef = 0;
        (pData.inventory || []).forEach(i => { if(i.equipped) { gearAtk += (i.atk || 0); gearDef += (i.def || 0); }});
        
        document.getElementById('g-hp-mp').innerText = `HP: ${pData.stats.hp}/${pData.stats.maxHp} | MP: ${pData.stats.mana}/${pData.stats.maxMana}`;
        document.getElementById('g-base').innerText = `Base Atk: ${pData.stats.atk} | Def: ${pData.stats.def}`;
        document.getElementById('g-gear').innerText = `Gear Boost: +${gearAtk} Atk | +${gearDef} Def`;
        
        // Use 'skills' field from DB
        const skillList = (pData.skills || []).map(s => `[${s}]`).join("<br>");
        document.getElementById('g-spells').innerHTML = skillList || "No skills found";
    }

    window.godRestore = async () => {
        pData.stats.hp = pData.stats.maxHp;
        pData.stats.mana = pData.stats.maxMana;
        await sync();
    };

    window.godGold = async (val) => {
        pData.gold = Math.max(0, (pData.gold || 0) + val);
        await sync();
    };

    window.godLevel = async (val) => {
        pData.level = Math.max(1, (pData.level || 1) + val);
        await sync();
    };

    window.godReset = async () => {
        if(!confirm("HARD RESET: Clear items, training, gold, and extra skills?")) return;
        pData.gold = 0;
        pData.exp = 0;
        pData.level = 1;
        pData.inventory = [];
        pData.training = { str: 0, agi: 0, int: 0 };
        pData.stats = { hp: 100, maxHp: 100, mana: 50, maxMana: 50, atk: 10, def: 5, luck: 0 };
        
        // Fix: Use skills field
        if(pData.skills && pData.skills.length > 0) pData.skills = [pData.skills[0]];
        
        await sync();
        location.reload();
    };

    // --- BATTLE LOGIC ---
    window.attemptSpawn = function() {
        if (!pData || isBusy || monster) return;
        document.getElementById('log').innerHTML = "";
        const zonePool = Object.values(MONSTER_DATABASE["THRESHOLD_OF_SOULS"]);
        const selected = zonePool[Math.floor(Math.random() * zonePool.length)];
        if (selected) {
            monster = JSON.parse(JSON.stringify(selected)); 
            monster.curHp = monster.hp;
            addLog(`Manifested ${monster.name}!`, "#eee");
        }
        updateUI();
    };

    window.attack = function() {
        if (!monster || isBusy) return;
        isBusy = true;
        let gearAtk = 0;
        (pData.inventory || []).forEach(i => { if(i.equipped) gearAtk += (i.atk || 0); });
        const result = calculateCombatResult((pData.stats?.atk || 10) + gearAtk, monster.def, pData.stats?.luck || 0);
        if (result.isMiss) addLog(`Missed!`, "#555");
        else {
            monster.curHp -= result.damage;
            addLog(`Hit for ${result.damage} DMG.`, result.isCrit ? "var(--gold)" : "var(--teal)");
            triggerShake('mSprite', false);
        }
        if (monster.curHp <= 0) setTimeout(handleVictory, 400);
        else setTimeout(monsterTurn, 600);
        updateUI();
    };

    window.useSkill = async function() {
        // Fix: Use skills array
        if (!monster || isBusy || !pData.skills || pData.skills.length === 0) return;
        
        const spellName = pData.skills[0];
        const manaCost = 15; // Default cost for Soul Strike

        if (pData.stats.mana < manaCost) {
            addLog("Not enough MP!", "var(--mana)");
            return;
        }

        isBusy = true;
        pData.stats.mana -= manaCost;
        
        let gearAtk = 0;
        (pData.inventory || []).forEach(i => { if(i.equipped) gearAtk += (i.atk || 0); });
        
        const baseAtk = (pData.stats?.atk || 10) + gearAtk;
        const spellDmg = Math.floor(baseAtk * 1.8); // 1.8x multiplier for Soul Strike
        const result = calculateCombatResult(spellDmg, monster.def, (pData.stats?.luck || 0) + 5);
        
        addLog(`Cast ${spellName}!`, "var(--mana)");
        if (result.isMiss) addLog(`The spell missed!`, "#555");
        else {
            monster.curHp -= result.damage;
            addLog(`${spellName} deals ${result.damage} DMG.`, "var(--teal)");
            triggerShake('mSprite', false);
        }

        if (monster.curHp <= 0) setTimeout(handleVictory, 400);
        else setTimeout(monsterTurn, 600);
        
        updateUI();
        await sync();
    };

    function monsterTurn() {
        if (!monster) { isBusy = false; return; }
        let gearDef = 0;
        (pData.inventory || []).forEach(i => { if(i.equipped) gearDef += (i.def || 0); });
        const mAtk = rollRange(monster.atkMin, monster.atkMax);
        const result = calculateCombatResult(mAtk, (pData.stats.def || 5) + gearDef, 0);
        if (!result.isMiss) {
            pData.stats.hp = Math.max(0, pData.stats.hp - result.damage);
            addLog(`${monster.name} deals ${result.damage} DMG.`, "var(--red)");
            triggerShake('mainScene', false);
        }
        isBusy = false;
        if (pData.stats.hp <= 0) handleDeath();
        else { sync(); updateUI(); }
    }

    function handleDeath() {
        isBusy = true;
        const overlay = document.getElementById('deathOverlay');
        overlay.style.display = 'flex';
        setTimeout(() => { window.location.href = "map.html"; }, 5000);
        sync();
    }

    async function handleVictory() {
        addLog(`Victory! +${monster.xp} XP`, "var(--gold)");
        pData.exp = (pData.exp || 0) + monster.xp;
        pData.gold = (pData.gold || 0) + monster.gold;
        processLevelUp(pData);
        monster = null;
        isBusy = false;
        await sync();
        setTimeout(() => { updateUI(); }, 800);
    }

    function updateUI() {
        if (!pData) return;
        document.getElementById('pLevel').innerText = `LVL ${pData.level || 1}`;
        const hasMonster = !!monster;
        
        // Fix: Updated Skill Detection for 'skills' array
        const skillBtn = document.getElementById('skillBtn');
        document.getElementById('atkBtn').disabled = !hasMonster || isBusy;

        if (pData.skills && pData.skills.length > 0) {
            const spellName = pData.skills[0];
            const cost = 15; 
            skillBtn.innerText = `${spellName} (${cost}MP)`;
            skillBtn.disabled = !hasMonster || isBusy || pData.stats.mana < cost;
        } else {
            skillBtn.innerText = "No Skill";
            skillBtn.disabled = true;
        }

        document.getElementById('nextBtn').style.display = hasMonster ? 'none' : 'block';
        
        if (monster) {
            document.getElementById('mHPFill').style.width = Math.max(0, (monster.curHp / monster.hp) * 100) + "%";
            document.getElementById('mHPText').innerText = `${Math.floor(monster.curHp)} / ${monster.hp}`;
            document.getElementById('mSprite').innerText = monster.emoji || "üëæ";
            document.getElementById('mMeta').innerText = `${monster.name} (LVL ${monster.level})`;
        } else {
            document.getElementById('mHPFill').style.width = "0%";
            document.getElementById('mHPText').innerText = "---";
            document.getElementById('mSprite').innerText = "üåë";
            document.getElementById('mMeta').innerText = "FLOOR CLEAR";
        }
        document.getElementById('pHPFill').style.width = (pData.stats?.hp / (pData.stats?.maxHp || 100)) * 100 + "%";
        document.getElementById('pMPFill').style.width = (pData.stats?.mana / (pData.stats?.maxMana || 50)) * 100 + "%";
        document.getElementById('hpCount').innerText = (pData.inventory || []).filter(i => i.id === "7").length;
        document.getElementById('mpCount').innerText = (pData.inventory || []).filter(i => i.id === "8").length;
    }

    function triggerShake(id, permanent) {
        const el = document.getElementById(id);
        if (el) { el.classList.add('shake'); if(!permanent) setTimeout(() => el.classList.remove('shake'), 200); }
    }

    async function sync() { if (auth.currentUser) await updateDoc(doc(db, "players", auth.currentUser.uid), pData); }
    function addLog(msg, color) {
        const l = document.getElementById('log');
        if (!l) return;
        l.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
        l.scrollTop = l.scrollHeight;
    }
</script>
</body>
</html>