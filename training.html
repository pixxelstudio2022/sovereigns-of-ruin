<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Grounds - Sovereigns of Ruin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { background: #000; margin: 0; display: flex; justify-content: center; overflow-x: hidden; font-family: 'Inter', sans-serif; }
        .game-container { width: 400px; min-height: 100vh; background: #000; padding: 15px; box-sizing: border-box; border-left: 1px solid #111; border-right: 1px solid #111; }

        .theme-Fire { --accent: #ff4444; }
        .theme-Water { --accent: #44aaff; }
        .theme-Wind { --accent: #62ffe1; }
        .theme-Earth { --accent: #aa7744; }
        .theme-Light { --accent: #ffffcc; }
        .theme-Shadow { --accent: #bb66ff; }

        .training-container { padding: 10px; text-align: center; }
        .gold-banner { background: #0a0a0a; padding: 12px; border-radius: 6px; margin-bottom: 25px; border: 1px solid #1a1a1a; font-size: 0.8rem; color: #666; letter-spacing: 1px; }
        .gold-banner span { color: var(--accent); font-weight: bold; }

        .stat-card { background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 8px; padding: 18px; margin-bottom: 15px; transition: 0.3s; }
        .stat-header { display: flex; justify-content: space-between; align-items: center; }
        .stat-info { text-align: left; }
        .stat-label { font-size: 0.6rem; color: #555; text-transform: uppercase; letter-spacing: 1.5px; }
        .stat-value { font-size: 1.1rem; font-weight: bold; color: #eee; margin-top: 4px; }
        .stat-lvl { color: var(--accent); font-weight: bold; margin-left: 5px; }
        
        .upgrade-btn { background: var(--accent); color: #000; border: none; padding: 10px 18px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.7rem; transition: 0.2s; letter-spacing: 1px; }
        .upgrade-btn:hover { filter: brightness(1.2); }
        .upgrade-btn:disabled { background: #1a1a1a; color: #444; cursor: not-allowed; opacity: 0.6; }

        .req-hint { font-size: 0.55rem; color: #444; margin-top: 5px; display: block; font-style: italic; }

        /* Progress Bar Animation */
        .progress-box { width: 100%; margin-top: 15px; display: none; }
        .progress-bg { width: 100%; height: 8px; background: #000; border-radius: 4px; overflow: hidden; border: 1px solid #1a1a1a; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.5s linear; box-shadow: 0 0 10px var(--accent); }
        .timer-text { font-size: 0.6rem; color: var(--accent); margin-top: 8px; letter-spacing: 1px; animation: pulse 2s infinite; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        .back-nav { font-size: 0.7rem; color: #444; cursor: pointer; margin-bottom: 20px; display: inline-block; transition: 0.2s; text-transform: uppercase; }
        .back-nav:hover { color: var(--accent); }
    </style>
</head>
<body id="bodyTheme">

    <div class="game-container">
        <div class="back-nav" onclick="window.location.href='map.html'">‚Üê Return to Village</div>

        <div class="training-container">
            <h2 style="letter-spacing: 4px; color: #fff; font-size: 1.2rem;">TRAINING GROUNDS</h2>
            <p style="font-size: 0.6rem; color: #444; margin-bottom: 25px; line-height: 1.5; text-transform: uppercase;">
                Strengthen the vessel. Limits are dictated by Sovereign Level.
            </p>

            <div class="gold-banner">
                RESERVE GOLD: <span id="displayGold">0</span>
            </div>

            <div class="stat-card" id="card-maxHp">
                <div class="stat-header">
                    <div class="stat-info">
                        <div class="stat-label">Vitality <span class="stat-lvl" id="lvl-maxHp">LV. 0</span></div>
                        <div class="stat-value" id="valHP">---</div>
                    </div>
                    <div style="text-align: right;">
                        <button class="upgrade-btn" id="btn-maxHp" onclick="startTraining('maxHp')">TRAIN (50G)</button>
                        <span class="req-hint" id="hint-maxHp">+20 HP | 2m</span>
                    </div>
                </div>
                <div class="progress-box" id="progress-maxHp">
                    <div class="progress-bg"><div class="progress-fill" id="fill-maxHp"></div></div>
                    <div class="timer-text" id="time-maxHp">CONDITIONING... --:--</div>
                </div>
            </div>

            <div class="stat-card" id="card-maxMana">
                <div class="stat-header">
                    <div class="stat-info">
                        <div class="stat-label">Arcane <span class="stat-lvl" id="lvl-maxMana">LV. 0</span></div>
                        <div class="stat-value" id="valMana">---</div>
                    </div>
                    <div style="text-align: right;">
                        <button class="upgrade-btn" id="btn-maxMana" onclick="startTraining('maxMana')">TRAIN (50G)</button>
                        <span class="req-hint" id="hint-maxMana">+10 MP | 2m</span>
                    </div>
                </div>
                <div class="progress-box" id="progress-maxMana">
                    <div class="progress-bg"><div class="progress-fill" id="fill-maxMana"></div></div>
                    <div class="timer-text" id="time-maxMana">CHANNELING... --:--</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { initSecurity } from "./auth-guard.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCfYnzHzZ82Qdvxsd2U4bSKpDwrQ8g2WuM",
            authDomain: "sovereigns-of-ruin.firebaseapp.com",
            projectId: "sovereigns-of-ruin",
            appId: "1:1098142064736:web:002a76b2e1f8f7b22f6305"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let pData = null;
        let timerInterval = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                initSecurity(db, auth, user);
                listenToPlayer(user.uid);
            } else { window.location.href = "index.html"; }
        });

        function listenToPlayer(uid) {
            onSnapshot(doc(db, "players", uid), (snap) => {
                if (snap.exists()) {
                    pData = snap.data();
                    checkCompletion(); // Check if training finished while offline
                    updateUI();
                }
            });
        }

        async function checkCompletion() {
            if (pData.trainingUntil && Date.now() >= pData.trainingUntil) {
                const stat = pData.trainingStat;
                const bonus = stat === 'maxHp' ? 20 : 10;
                const path = `stats.${stat}`;
                const lvlPath = `trainingLevels.${stat}`;

                // Create update object
                const update = {
                    trainingUntil: null,
                    trainingStat: null,
                    trainingTotalTime: null,
                    [path]: increment(bonus),
                    [lvlPath]: increment(1)
                };

                // If training HP, also heal the player for the same amount
                if (stat === 'maxHp') update['stats.hp'] = increment(20);

                await updateDoc(doc(db, "players", auth.currentUser.uid), update);
            }
        }

        function updateUI() {
            document.getElementById('displayGold').innerText = pData.gold;
            document.getElementById('valHP').innerText = pData.stats.maxHp + " MAX HP";
            document.getElementById('valMana').innerText = pData.stats.maxMana + " MAX MP";
            
            const hpLvl = pData.trainingLevels?.maxHp || 0;
            const manaLvl = pData.trainingLevels?.maxMana || 0;
            
            document.getElementById('lvl-maxHp').innerText = `LV. ${hpLvl}`;
            document.getElementById('lvl-maxMana').innerText = `LV. ${manaLvl}`;

            document.getElementById('hint-maxHp').innerText = `+20 HP | ${(hpLvl + 1) * 2}M`;
            document.getElementById('hint-maxMana').innerText = `+10 MP | ${(manaLvl + 1) * 2}M`;

            handleTrainingState('maxHp', hpLvl);
            handleTrainingState('maxMana', manaLvl);
        }

        function handleTrainingState(statKey, currentLvl) {
            const btn = document.getElementById(`btn-${statKey}`);
            const hint = document.getElementById(`hint-${statKey}`);
            const progBox = document.getElementById(`progress-${statKey}`);
            
            if (pData.trainingStat === statKey && pData.trainingUntil) {
                btn.style.display = "none";
                hint.style.display = "none";
                progBox.style.display = "block";
                startLocalTimer(statKey);
            } else {
                btn.style.display = "block";
                hint.style.display = "block";
                progBox.style.display = "none";

                const atCap = currentLvl >= pData.level;
                btn.disabled = (pData.trainingUntil || pData.gold < 50 || atCap);
                
                if (atCap) {
                    btn.innerText = "CAP REACHED";
                    hint.innerText = "Level Up in Wildlands";
                } else {
                    btn.innerText = "TRAIN (50G)";
                }
            }
        }

        function startLocalTimer(statKey) {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                const now = Date.now();
                const diff = pData.trainingUntil - now;

                if (diff <= 0) {
                    clearInterval(timerInterval);
                    checkCompletion(); // Final trigger to apply stats
                    return;
                }

                const total = pData.trainingTotalTime || ((pData.trainingLevels[statKey] + 1) * 120000);
                const percent = Math.min(100, ((total - diff) / total) * 100);
                document.getElementById(`fill-${statKey}`).style.width = percent + "%";

                const mins = Math.floor(diff / 60000);
                const secs = Math.floor((diff % 60000) / 1000);
                document.getElementById(`time-${statKey}`).innerText = 
                    `${statKey === 'maxHp' ? 'CONDITIONING' : 'CHANNELING'}... ${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }, 1000);
        }

        window.startTraining = async (statKey) => {
            if (pData.trainingUntil) return; // Prevent double trigger
            const currentLvl = pData.trainingLevels?.[statKey] || 0;
            
            if (pData.gold < 50) return alert("Insufficient gold.");
            if (currentLvl >= pData.level) return alert("Vessel capacity reached.");

            const minutes = (currentLvl + 1) * 2;
            const ms = minutes * 60 * 1000;
            const finishTime = Date.now() + ms;

            await updateDoc(doc(db, "players", auth.currentUser.uid), {
                gold: increment(-50),
                trainingUntil: finishTime,
                trainingStat: statKey,
                trainingTotalTime: ms
            });
        };
    </script>
</body>
</html>